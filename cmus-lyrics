#!/usr/bin/env python2
# -*- coding: utf-8 -*-
# This program is free software. It comes without any warranty, to
# the extent permitted by applicable law. You can redistribute it
# and/or modify it under the terms of the Do What The Fuck You Want
# To Public License, Version 2, as published by Sam Hocevar. See
# http://sam.zoy.org/wtfpl/COPYING for more details.

import socket

origGetAddrInfo = socket.getaddrinfo


def getAddrInfoWrapper(host, port, family=0, socktype=0, proto=0, flags=0):
    return origGetAddrInfo(host, port, socket.AF_INET, socktype, proto, flags)

socket.getaddrinfo = getAddrInfoWrapper


class cmus:
    def __init__(self):
        import os

        self.status = os.popen('cmus-remote -Q').read().split('\n')
        for line in self.status:
            if 'tag artist' in line:
                self.artist = line.split('tag artist ')[1]
            elif 'tag title' in line:
                self.title = line.split('tag title ')[1]


class lyrics:
    def __init__(self, artist, title):
        self.artist = artist
        self.title = title

    def get(self):
        import re
        import json
        from urllib2 import urlopen
        from urllib import quote_plus

        keywords = quote_plus('%s %s sing365' % (self.artist, self.title))
        page = urlopen('http://ajax.googleapis.com/ajax/services/search/web?v=1.0&q=%s' % keywords)
        raw = page.read()
        page.close()
        self.url = "".join(str(json.loads(raw)['responseData']['results'][0]['url']))

        page = urlopen(self.url)
        raw = page.read()
        page.close()

        if 'Submit %s New Lyrics' % self.artist in raw:
            self.lyrics = 'No lyrics found.'
        else:
            self.lyrics = self.artist + ' - ' + self.title + '\n\n' + \
                          re.compile(r'<.*?>').sub('', \
                          raw.split('border=0><br>')[1] \
                          .split('<div class=unit>')[0] \
                          .replace('&quot;', '"') \
                          .strip())

    def show(self):
        print self.lyrics


if __name__ == '__main__':
    c = cmus()
    l = lyrics(c.artist, c.title)
    l.get()
    l.show()
