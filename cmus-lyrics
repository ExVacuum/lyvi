#!/usr/bin/env python2
# -*- coding: utf-8 -*-
# This program is free software. It comes without any warranty, to
# the extent permitted by applicable law. You can redistribute it
# and/or modify it under the terms of the Do What The Fuck You Want
# To Public License, Version 2, as published by Sam Hocevar. See
# http://sam.zoy.org/wtfpl/COPYING for more details.

import socket

origGetAddrInfo = socket.getaddrinfo


def getAddrInfoWrapper(host, port, family=0, socktype=0, proto=0, flags=0):
    return origGetAddrInfo(host, port, socket.AF_INET, socktype, proto, flags)

socket.getaddrinfo = getAddrInfoWrapper


class cmus:
    def __init__(self):
        import os

        self.status = os.popen('cmus-remote -Q').read().split('\n')
        for line in self.status:
            if 'tag artist' in line:
                self.artist = line.split('tag artist ')[1]
            elif 'tag title' in line:
                self.title = line.split('tag title ')[1]


class lyrics:
    def get(self, artist, title):
        import re
        from urllib2 import urlopen

        page = urlopen('http://www.lyrics.com/%s-lyrics-%s.html' %
                        (title.replace(' ', '-'), artist.replace(' ', '-')))
        raw = page.read()
        page.close()
        if 'we do not have the lyric for this song.' in raw:
            self.lyrics = 'No lyrics found'
        elif '<div id="lyric_space">' not in raw:
            self.lyrics = 'No lyrics found'
        else:
            self.lyrics = artist + ' - ' + title + '\n\n' + \
                          re.compile(r'<.*?>').sub('',
                          raw.split('<div id="lyric_space">')[1] \
                          .split('---')[0] \
                          .replace('&#8230;', '...') \
                          .replace('&#8217;', '\'') \
                          .replace('&#1492;', 'Ã¤') \
                          .strip())

    def show(self):
        print self.lyrics


c = cmus()
l = lyrics()
l.get(c.artist, c.title)
l.show()
